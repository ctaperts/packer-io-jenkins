{
  "builders": [
    {
      "type": "digitalocean",
      "ssh_username": "root",
      "api_token": "{{ user `secret_api_token` }}",
      "droplet_name": "building-image-jenkins",
      "snapshot_name": "packer jenkins {{isotime \"02-Jan-06 03:04:05\"}}",
      "image": "ubuntu-16-04-x64",
      "region": "{{ user `image_region` }}",
      "size": "512mb"
    }
  ],
  "provisioners": [
    {
      "type": "shell",
       "environment_vars": [
        "JENKINS_USERNAME={{ user `jenkins_username` }}",
        "JENKINS_PASSWORD={{ user `jenkins_password` }}"
    ],
      "inline": [
        "### SETUP ###",
        "apt-get update",

        "### NOTES ###",
        "# Digital Ocean is using root, does not need sudo",

        "### START ###",
        "useradd -m $JENKINS_USERNAME",
        "echo $JENKINS_USERNAME:$JENKINS_PASSWORD | chpasswd",
        "# SETUP JENKINS",
        "## Install Java OpenJDK 7 and Install Jenkins",
        "apt-get install software-properties-common",
        "add-apt-repository ppa:openjdk-r/ppa -y",
        "wget -q -O - https://pkg.jenkins.io/debian-stable/jenkins.io.key | sudo apt-key add -",
        "echo 'deb https://pkg.jenkins.io/debian-stable binary/' | tee -a /etc/apt/sources.list",
        "apt-get update",
        "apt-get install -y openjdk-7-jdk jenkins mlocate",
        "systemctl start jenkins",
        "systemctl enable jenkins",
        "updatedb",

        "## Add Jenkins User",
        "echo 'jenkins.model.Jenkins.instance.securityRealm.createAccount(\"$JENKINS_USERNAME\", \"$JENKINS_PASSWORD\")' | java -jar `locate jenkins-cli.jar` -auth admin:`cat /var/lib/jenkins/secrets/initialAdminPassword` -s http://localhost:8080/ groovy =",

        "# SETUP APACHE REVERSE PROXY",
        "apt-get install apache2",
        "a2enmod proxy proxy_http proxy_html",
        "systemctl restart apache2",
        "systemctl enable apache2"

      ]
    }
  ]
}
